<?xml version='1.0' encoding='UTF-8'?>
<!-- 
  Copyright 2008 California Institute of Technology. ALL RIGHTS
  RESERVED. U.S. Government Sponsorship acknowledged.
  
  Author: Chris A. Mattmann
  Description: eCAS maven build script. Sets up the eCAS delivery
  deployment directory structure, and installs the filemgr, crawler
  and other goodies into the appropriate places.
  
-->
<project default='javaapp' xmlns:ant="jelly:ant" xmlns:maven="jelly:maven"
  xmlns:deploy="deploy" xmlns:j='jelly:core'>

  <goal name='dist:prepare-bin-filesystem'
    prereqs='xdoc:init, jar:jar, site:generate'
    description='Builds the binary distribution file system'>
    <ant:delete dir='${maven.dist.bin.assembly.dir}' />
    <ant:mkdir dir='${maven.dist.bin.assembly.dir}' />

    <!--  have ant read all the system env vars
      and copy them to a property called env
    -->
    <ant:property environment="env" />

    <!--  create the skeleton directory structure-->
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/crawler" />
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/filemgr" />
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/products" />
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/logs" />
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/etc" />
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/met_output_dir" />

    <!--  etc dir -->
    <ant:copy todir="${maven.dist.bin.assembly.dir}/etc"
      file="${basedir}/src/resources/ecas_metdb_fhcrc.csv" />


    <!-- lib dir -->
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/lib" />

    <!--  we need to patch the filemgr with the new version of cas-metadata -->
    <deploy:copy-deps todir="${maven.dist.bin.assembly.dir}/lib" />
    <ant:delete>
      <!--  delete everything but cas-metadata -->
      <fileset dir="${maven.dist.bin.assembly.dir}/lib">
        <exclude name="cas-metadata-${cas.metadata.version}.jar" />
      </fileset>
    </ant:delete>

    <!--  now copy the seldi jar deliverable -->
    <ant:copy todir='${maven.dist.bin.assembly.dir}/lib'>
      <ant:fileset dir='${maven.build.dir}'>
        <ant:include name='${maven.final.name}.jar' />
      </ant:fileset>
    </ant:copy>

    <!--  run dir -->
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/run" />

    <!-- install dir -->
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/install" />
    <ant:copy todir='${maven.dist.bin.assembly.dir}/install'>
      <ant:fileset dir='${basedir}/src/resources/installscripts'>
        <ant:include name="*" />
      </ant:fileset>
    </ant:copy>

    <!-- copy all programs to scripts -->
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/scripts" />
    <ant:copy todir="${maven.dist.bin.assembly.dir}/scripts">
      <fileset dir="${basedir}/src/bin">
        <include name="*" />
      </fileset>
    </ant:copy>

    <!--  chmod to +x on all scripts -->
    <ant:chmod dir="${maven.dist.bin.assembly.dir}/scripts" perm="ugo+rwx"
      includes="*" />

    <ant:copy
      file="${basedir}/src/resources/filemgr/dist/cas-filemgr-${cas.filemgr.version}.tar.gz"
      todir="${maven.dist.bin.assembly.dir}/filemgr" />

    <!-- now untar the filemgr -->
    <ant:gunzip
      src="${maven.dist.bin.assembly.dir}/filemgr/cas-filemgr-${cas.filemgr.version}.tar.gz"
      dest="${maven.dist.bin.assembly.dir}/filemgr" />
    <ant:untar
      src="${maven.dist.bin.assembly.dir}/filemgr/cas-filemgr-${cas.filemgr.version}.tar"
      dest="${maven.dist.bin.assembly.dir}/filemgr/" />

    <!-- move the filemgr files to the appropriate location -->
    <ant:copy todir="${maven.dist.bin.assembly.dir}/filemgr">
      <fileset
        dir="${maven.dist.bin.assembly.dir}/filemgr/cas-filemgr-${cas.filemgr.version}" />
    </ant:copy>

    <!-- remove temporary files -->
    <ant:delete
      dir="${maven.dist.bin.assembly.dir}/filemgr/cas-filemgr-${cas.filemgr.version}" />
    <ant:delete
      file="${maven.dist.bin.assembly.dir}/filemgr/cas-filemgr-${cas.filemgr.version}.tar" />
    <ant:delete
      file="${maven.dist.bin.assembly.dir}/filemgr/cas-filemgr-${cas.filemgr.version}.tar.gz" />

    <!--  install specific filemgr server and client scripts -->
    <ant:copy todir="${maven.dist.bin.assembly.dir}/filemgr/bin"
      overwrite="true">
      <fileset dir="${basedir}/src/resources/filemgr/bin">
        <include name="filemgr*" />
      </fileset>
    </ant:copy>

    <!--  make scripts executable -->
    <ant:chmod dir="${maven.dist.bin.assembly.dir}/filemgr/bin" perm="ugo+rwx"
      includes="*" />

    <!--  patch the cas-metadata jar -->
    <ant:delete
      file="${maven.dist.bin.assembly.dir}/filemgr/lib/cas-metadata-${cas.metadata.old.version}.jar" />
    <ant:copy todir="${maven.dist.bin.assembly.dir}/filemgr/lib"
      file="${maven.dist.bin.assembly.dir}/lib/cas-metadata-${cas.metadata.version}.jar" />
    <ant:delete
      file="${maven.dist.bin.assembly.dir}/lib/cas-metadata-${cas.metadata.version}.jar" />

    <!--  remove default policy files -->
    <ant:delete>
      <!--  delete the default policy -->
      <fileset dir="${maven.dist.bin.assembly.dir}/filemgr/policy">
        <include name="*.xml" />
      </fileset>
    </ant:delete>

    <!-- install the SELDI specific policy files -->
    <ant:copy todir="${maven.dist.bin.assembly.dir}/filemgr/policy/seldi"
      overwrite="true">
      <!--  copy SELDI  policy files -->
      <fileset dir="${basedir}/src/resources/filemgr/policy">
        <include name="*.xml" />
      </fileset>
    </ant:copy>

    <!-- install the configuration files -->
    <ant:copy todir="${maven.dist.bin.assembly.dir}/filemgr/etc"
      overwrite="true">
      <fileset dir="${basedir}/src/resources/filemgr/configuration">
        <include name="*.properties" />
      </fileset>
    </ant:copy>

    <!--  env var replace on the logging.property files to make sure they get written to
      $EDRN_ECAS_HOME/logs
    -->
    <ant:replace
      file="${maven.dist.bin.assembly.dir}/filemgr/etc/logging.properties"
      token="[EDRN_ECAS_HOME]" value="${env.EDRN_ECAS_HOME}" />

    <ant:copy
      file="${basedir}/src/resources/crawler/dist/cas-crawler-${cas.crawler.version}.tar.gz"
      todir="${maven.dist.bin.assembly.dir}/crawler" />

    <!-- now untar the crawler -->
    <ant:gunzip
      src="${maven.dist.bin.assembly.dir}/crawler/cas-crawler-${cas.crawler.version}.tar.gz"
      dest="${maven.dist.bin.assembly.dir}/crawler" />
    <ant:untar
      src="${maven.dist.bin.assembly.dir}/crawler/cas-crawler-${cas.crawler.version}.tar"
      dest="${maven.dist.bin.assembly.dir}/crawler/" />

    <!-- move the crawler files to the appropriate location -->
    <ant:copy todir="${maven.dist.bin.assembly.dir}/crawler">
      <fileset
        dir="${maven.dist.bin.assembly.dir}/crawler/cas-crawler-${cas.crawler.version}" />
    </ant:copy>

    <!-- remove temporary files -->
    <ant:delete
      dir="${maven.dist.bin.assembly.dir}/crawler/cas-crawler-${cas.crawler.version}" />
    <ant:delete
      file="${maven.dist.bin.assembly.dir}/crawler/cas-crawler-${cas.crawler.version}.tar" />
    <ant:delete
      file="${maven.dist.bin.assembly.dir}/crawler/cas-crawler-${cas.crawler.version}.tar.gz" />

    <!--  make scripts executable -->
    <ant:chmod dir="${maven.dist.bin.assembly.dir}/crawler/bin" perm="ugo+rwx"
      includes="*" />

  </goal>


</project>
